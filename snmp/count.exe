use strict;
use warnings;
use Getopt::Long;

my $show_all=0;
GetOptions('a'=>\$show_all);

my @logfiles=('/var/log/auth.log','/var/log/secure');
my $logfile;

foreach my $file (@logfiles){
	if (-r $file){
		$logfile=$file;
		last;
	}
}

exit 0 unless $logfile;

open(my $fh,'<',$logfile) or exit 0;

my @arrsudo;

while (my $line=<$fh>){
	if ($line=~ /^(\w+\s+\d+\s+\d+:\d+).*sudo:\s+(\w+).*USER=(\w+)/){
		push @arrsudo,{
			datetime=> $1,
			src     => $2,
			dst     => $3
		};
	}
}

close($fh);

if($show_all){
	printf "%-20s %-15s %-15s\n", "DATE / TIME","SOURCE USER","TARGET USER";
	printf "%-20s %-15s %-15s\n", "-" x 20,"-" x 15,"-" x 15;

	foreach my $entry(@arrsudo){
		printf"%-20s %-15s %-15s\n",
			$entry->{datetime},
			$entry->{src},
			$entry->{dst};

		}
	}
} else{
	print scalar(@arrsudo);
}
